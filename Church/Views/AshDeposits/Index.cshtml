@model List<tblAshDeposits>
@{
    ViewBag.Title = "SOLICITUD NO." + ViewBag.PurchasesRequestID + " CLAVE " + ViewBag.Nicho;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using (Ajax.BeginForm(
                    new AjaxOptions
                    {
                        HttpMethod = "get",
                        InsertionMode = InsertionMode.Replace,
                        UpdateTargetId = "AshDepositsList"
                    }))
{
    <div class="card">
        <div class="card-header card-header-green">
            <div class="row">
                <div class="col-md-10">
                    <h2>@ViewBag.Title</h2>
                </div>
                @if (Model.Count < 5 && ViewBag.CryptType == "Familiar")
                {
                    <div class="col-md-2 col-sm-2 col-xs-12">
                        <p style="text-align:right; padding-top:20px">
                            <a style="width:100%;" href="@Url.Action("Formato","AshDeposits",new { id=ViewBag.PurchasesRequestID})" class="btn btn-default btn-large">Agregar</a>
                        </p>
                    </div>
                }
                else if (Model.Count < 1 && ViewBag.CryptType == "Individual")
                {
                    <div class="col-md-2 col-sm-2 col-xs-12">
                        <p style="text-align:right; padding-top:20px">
                            <a style="width:100%;" href="@Url.Action("Formato","AshDeposits",new { id=ViewBag.PurchasesRequestID})" class="btn btn-default btn-large">Agregar</a>
                        </p>
                    </div>
                }
            </div>
        </div>
        <div class="card-body">
            <div class="row">

            </div>
            <div id="AshDepositsList">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <tr class="tableStyleHeader" style="color:white!important">
                            <th>
                                Nombre
                            </th>
                            <th>
                                Fecha de defunción
                            </th>
                            <th>
                                Hora del deposito
                            </th>
                            <th>
                                Fecha deposito de cenizas
                            </th>
                            <th>
                                Acta de defunción
                            </th>
                            <th>
                                Permiso de cremación
                            </th>
                            <th>
                                Recibo
                            </th>
                            <th></th>
                        </tr>
                        @if (Model.Count == 0)
                        {
                            <tr>
                                <td colspan="10" style="text-align:center"><label>No se encontraron resultados</label></td>
                            </tr>
                        }
                        @foreach (var item in Model)
                        {
                            <tr class="tableStylerow">
                                <td>
                                    @Html.DisplayFor(modelItem => item.Name)
                                </td>
                                <td>
                                    @item.DeathDate.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    @item.AshDepositDate.ToString("hh:mm tt")
                                </td>
                                <td>
                                    @item.AshDepositDate.ToString("dd/MM/yyyy")
                                </td>
                                <td>
                                    <button type="button" class="btn btn-info btn-show-picture btn-sm" style="width:64%" img="@item.DeathCertificate">ver</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-info btn-show-picture btn-sm" style="width:64%" img="@item.CremationCertificate">ver</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-info btn-show-picture btn-sm" style="width:100%" img="@item.Ticket">ver</button>
                                </td>
                                <td align="center">
                                    @Html.ActionLink("Ver Registro", "Details", new { id = item.AshDepositID }, new { @class = "" })
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<div class="modal fade" id="modalPicture" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"></h5>
                <button type="button" class="btn-close btn" data-dismiss="modal" aria-label="Close">x</button>
            </div>
            <div class="modal-body" style="text-align:center">
                <img id="imgPic" src="" style="max-width:100%;max-height:100%" />
                @*<embed id="pdfPIC" src="files/Brochure.pdf" type="application/pdf" width="100%" height="600px" />*@
                <embed id="pdfPIC" src="" type="application/pdf" width="100%" height="600px" />
                <label id="SinArchivo" style="font-size:70px">No hay archivo</label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                @*<a class="btn btn-primary link-download" href="" target="_blank">Descargar</a>*@
                <a id="link-download" href="" class="btn btn-primary">Descargar</a>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/ui.datepicker-es-MX.js"></script>
    <script type="text/javascript">
        $(function () {
            $.datepicker.setDefaults($.datepicker.regional['es-MX']);
            $(".datepicker").datepicker();
        });

        //$(".btn-show-picture").click(function () {
        //    var aNameFile = $(this).attr("img").split('.');
        //    if (aNameFile.length > 0 && aNameFile[(aNameFile.length - 1)] == "pdf") {
        //        $("#pdfPIC").remove();
        //        $(".modal-body").append('<embed id = "pdfPIC" src = "files/Brochure.pdf" type = "application/pdf" width = "100%" height = "600px" />');
        //        $("#pdfPIC").show();
        //        $("#pdfPIC").attr("src", $(this).attr("img"));
        //        $("#imgPic").hide();
        //    } else {
        //        $("#imgPic").show();
        //        $("#imgPic").attr("src", $(this).attr("img"));
        //        $("#pdfPIC").hide();
        //    }
        //    $(".link-download").attr("href", $(this).attr("img"));
        //    $('#modalPicture').modal('show');
        //});

        $(".btn-show-picture").click(function () {
            var billpath = $(this).attr("img");

            $.ajax({
                url: '@Url.Action("SearchArchiveAshDeposits", "AshDeposits")',
                type: 'POST',
                dataType: 'json',
                data: ({ 'billpath': billpath }),
                success: function (data) {
                    if (data.respuesta == "") {
                        if (data.base64ImageRepresentation != "") {
                            $("#imgPic").show();
                            $("#imgPic").attr("src", data.base64ImageRepresentation);
                            $("#pdfPIC").hide();
                            $("#SinArchivo").hide();
                            $("#link-download").show();
                            $("#link-download").attr("href", data.pathbill);
                        }
                        else if (data.base64StringPDF != "") {
                            $("#pdfPIC").remove();
                            $(".modal-body").append('<embed id = "pdfPIC" src = "" type = "application/pdf" width = "100%" height = "600px" />');
                            $("#pdfPIC").attr("src", data.base64StringPDF);
                            $("#imgPic").hide();
                            $("#SinArchivo").hide();
                            $("#link-download").show();
                            $("#link-download").attr("href", data.pathbill);
                        }
                    }
                    else {
                        $("#pdfPIC").hide();
                        $("#imgPic").hide();
                        $("#SinArchivo").show();
                        $("#link-download").hide();
                    }
                },
                error: function (error) {
                    swal('Ocurrio un error.', {
                        icon: "error",
                    });
                }
            });

            $('#modalPicture').modal('show');

        });

    </script>
}
